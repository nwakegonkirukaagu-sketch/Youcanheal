<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouCanHeal Dashboard</title>
<link rel="icon" type="image/png" href="images/youcanheal-logo.png">

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AeAkNJQMO6eiYY-v0IsWHNm64M3nHUnFaqKZ0iICehGrAVufHv1c3DGLNPXRkbKjjTJ_0cjN0Slc5tZz&vault=true&intent=subscription"></script>

<style>
/* (Your CSS unchanged) */
:root {
--bg:#f8fafc;--card:#ffffff;--accent:#10b981;--accent-2:#3b82f6;--accent-3:#9B59B6;--accent-soft:#d1fae5;
--text:#1f2937;--text-secondary:#374151;--muted:#6b7280;--border:#e5e7eb;--hover:#f3f4f6;
--button:var(--accent);--button-hover:#059669;--alert:#FFBF00;--error:#FF6F61;
}
[data-theme="dark"] {
--bg:#121212;--card:#1E1E1E;--accent:#A3D3B8;--accent-2:#4A90E2;--accent-3:#9B59B6;--accent-soft:#1a2a25;
--text:#E0E0E0;--text-secondary:#B0B0B0;--muted:#B0B0B0;--border:#2A2A2A;--hover:#1A1A1A;
--button:#4A90E2;--button-hover:#6AA6EA;--alert:#FFBF00;--error:#FF6F61;
}
*{box-sizing:border-box;transition:background .3s ease,color .3s ease,border .3s ease}
body{margin:0;font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(135deg,var(--bg) 0%,var(--hover) 100%);color:var(--text);min-height:100vh;line-height:1.6}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;background:linear-gradient(135deg,var(--accent) 0%,var(--accent-2) 100%);color:white;box-shadow:0 4px 20px rgba(16,185,129,.2);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
header nav a{color:white;text-decoration:none;margin-left:16px;font-weight:600;text-shadow:0 0 8px rgba(255,255,255,.3)}
.container{max-width:1100px;margin:30px auto;padding:0 18px;display:grid;grid-template-columns:repeat(12,1fr);gap:20px}
.card{background:var(--card);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(16,185,129,.08);border:1px solid var(--border);transition:all .3s ease;backdrop-filter:blur(10px)}
.card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(16,185,129,.15);border-color:var(--accent)}
.big{grid-column:span 8}.side{grid-column:span 4}
@media(max-width:900px){.big,.side{grid-column:span 12}}
h2{margin:0 0 12px 0;color:var(--text);font-weight:600;font-size:1.3rem}
h2::before{content:'';display:inline-block;width:4px;height:20px;background:linear-gradient(135deg,var(--accent),var(--accent-2));border-radius:2px;margin-right:8px;vertical-align:middle}
.muted{color:var(--muted);font-size:.95rem}
.btn{background:var(--button);color:white;border:none;padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 15px rgba(74,144,226,.25);transition:all .2s ease;font-size:.95rem}
.btn:hover{background:var(--button-hover);transform:translateY(-1px);box-shadow:0 6px 20px rgba(74,144,226,.35)}
.smallbtn{background:var(--card);border:1px solid var(--accent-2);color:var(--accent-2);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:500;transition:all .2s ease}
.smallbtn:hover{background:var(--accent-2);color:white;transform:translateY(-1px)}
#chatBox{height:260px;overflow:auto;padding:15px;border-radius:12px;background:var(--accent-soft);border:1px solid var(--border)}
.msg{padding:12px 15px;border-radius:12px;margin-bottom:10px;max-width:85%;line-height:1.5;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.msg.user{background:var(--accent-2);color:white;margin-left:auto}
.msg.ai{background:var(--card);color:var(--text);border:1px solid var(--border)}
.theme-toggle{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:500}
footer{text-align:center;color:var(--muted);padding:20px;font-size:.9rem}
.logo{height:50px;width:auto}
.logo-area{display:flex;align-items:center}
#donationFab{position:fixed;bottom:22px;right:22px;background:linear-gradient(135deg,#d8b4fe,#a78bfa);color:white;border:none;padding:14px 18px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 8px 25px rgba(167,139,250,.45);z-index:80}
#donationModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:90}
.donation-card{background:var(--card,#fff);border-radius:18px;padding:24px;width:320px;box-shadow:0 20px 45px rgba(0,0,0,.25);position:relative;border:1px solid var(--border);text-align:center}
#donationClose{position:absolute;top:10px;right:10px;border:none;background:transparent;font-size:20px;cursor:pointer;color:var(--muted)}
.donation-card .donate-amount{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);margin-top:10px;background:var(--hover);color:var(--text);font-weight:600;cursor:pointer}
.donation-card .donate-amount.active{background:linear-gradient(135deg,#d8b4fe,#a78bfa);color:white;border-color:transparent}
#stripeDonateBtn{width:100%;margin-top:14px;border-radius:999px}
#paypal-button-container{margin-top:12px}
#contactBtn{position:fixed;bottom:22px;left:22px;background:rgba(15,23,42,.92);color:#f9fafb;border:none;padding:12px 16px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 8px 22px rgba(15,23,42,.45);z-index:80}
#contactModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:95}
.contact-card{background:var(--card,#fff);border-radius:18px;padding:26px;width:340px;max-width:90vw;box-shadow:0 18px 40px rgba(0,0,0,.25);border:1px solid var(--border);position:relative}
#contactClose{position:absolute;top:12px;right:12px;border:none;background:transparent;font-size:20px;cursor:pointer;color:var(--muted)}
</style>
</head>

<body data-theme="light">

<!-- âœ… SINGLE SUPABASE + AUTH GUARD (ONE SOURCE OF TRUTH) -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://hrpxfnrizypnqwsiasqw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycHhmbnJpenlwbnF3aWFzcXciLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc1OTAwNjUyNSwiZXhwIjoyMDc0NTgyNTI1fQ.4btbG22BF7WWtCvq1Du7Bo0aLcKHZIUV4MBwPQW53eY";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function bootAuth() {
  try {
    // If arriving from magic link, exchange token and store session
    if (window.location.hash && window.location.hash.includes("access_token")) {
      await supabase.auth.getSessionFromUrl({ storeSession: true });
      // Clean the URL so it doesn't repeat on refresh
      window.history.replaceState({}, document.title, "/dashboard.html");
    }

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.replace("/index.html");
      return;
    }

    // Expose for the rest of the page scripts
    window.__supabase = supabase;
    window.__user = session.user;

    const usernameEl = document.getElementById("username");
    if (usernameEl) usernameEl.textContent = session.user.email;

  } catch (e) {
    console.error("Dashboard auth failed:", e);
    window.location.replace("/index.html");
  }
}

window.signOut = async function signOut() {
  try { await supabase.auth.signOut(); } catch(e) {}
  window.location.replace("/index.html");
};

bootAuth();
</script>

<header>
  <div class="logo-area">
    <img src="images/youcanheal-logo.png" alt="YouCanHeal Logo" class="logo">
  </div>
  <nav>
    <a href="#boost">Daily Boost</a>
    <a href="#steps">Steps</a>
    <a href="#luna">Luna</a>
    <a href="#coping">Coping</a>
    <a href="/meditations.html">Meditations</a>
  </nav>
  <div style="display:flex;align-items:center;gap:10px;">
    <span id="username" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Guest</span>
    <button class="theme-toggle" id="themeToggle" type="button">ğŸŒ™ Dark</button>
    <button class="smallbtn" onclick="signOut()">Sign Out</button>
  </div>
</header>

<div class="container">
  <div class="card big" id="boost">
    <h2>ğŸŒ¸ Today's Gentle Boost</h2>
    <p id="boostText" class="muted">Loading your gentle message...</p>
    <button class="btn" onclick="getBoost()">Get Today's Boost</button>
  </div>

  <div class="card side" id="steps">
    <h2>ğŸš¶â€â™€ï¸ Daily Steps</h2>
    <p>Steps Today: <strong id="stepsCount">0</strong></p>
    <input type="number" id="addStepsInput" placeholder="Add steps..." style="width:100%; margin:10px 0; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text);" />
    <button class="btn" onclick="addSteps()">+ Add Steps</button>
  </div>

  <div class="card side" id="mood">
    <h2>ğŸ’­ Mood Checker</h2>
    <p class="muted">How are you feeling today?</p>
    <div class="mood-btns" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;">
      <button class="btn" onclick="logMood('Happy')">ğŸ˜Š Happy</button>
      <button class="btn" onclick="logMood('Okay')">ğŸ˜ Okay</button>
      <button class="btn" onclick="logMood('Sad')">ğŸ˜” Sad</button>
      <button class="btn" onclick="logMood('Anxious')">ğŸ˜° Anxious</button>
    </div>
    <div id="moodLog" class="muted" style="margin-top:10px;">No moods logged yet.</div>
  </div>

  <div class="card side" id="featured-meditation">
    <h2>ğŸ§ Featured Meditation</h2>
    <div class="muted" id="miniTitle">Loading track...</div>
    <div class="muted" id="miniBy" style="margin-bottom:8px;">â€”</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn" id="miniPlayBtn">Play</button>
      <button class="smallbtn" onclick="window.location.href='meditations.html'">Open Library</button>
      <audio id="miniAudio" preload="auto" style="display:none;"></audio>
    </div>
  </div>

  <div class="card big" id="luna">
    <h2>ğŸŒ™ Chat with Luna</h2>
    <div id="chatBox">
      <div class="msg ai">Hi there! ğŸ’› I'm Luna, your wellbeing companion. How are you feeling today?</div>
    </div>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <input type="text" id="chatInput" placeholder="Say hi to Luna..." style="flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text);" />
      <button class="btn" onclick="sendMessage()">Send</button>
      <button class="smallbtn" onclick="clearChat()">Clear</button>
    </div>
    <p class="muted" style="margin-top:8px;font-size:.85rem;">Luna provides emotional support and is not a substitute for medical advice.</p>
  </div>

  <div class="card side" id="coping">
    <h2>ğŸŒ¿ Coping Library</h2>
    <ul style="line-height:1.6; padding-left:20px;">
      <li><strong>Deep Breathing:</strong> Inhale 4s, hold 4s, exhale 4s. Repeat 5x.</li>
      <li><strong>5-4-3-2-1 Grounding:</strong> Notice 5 things you see, 4 feel, 3 hear, 2 smell, 1 taste.</li>
      <li><strong>Mini Gratitude:</strong> Write 3 things that made you smile today.</li>
      <li><strong>Gentle Movement:</strong> Stretch your arms, roll your shoulders, or take a short walk.</li>
      <li><strong>Self-Compassion:</strong> Speak to yourself like you would to a dear friend.</li>
    </ul>
  </div>
</div>

<footer>
  <p>Â© YouCanHeal â€¢ All rights reserved â€¢ <a href="privacy.html">Privacy & Cookies</a></p>
  <p style="font-size:.85rem;opacity:.8;">This platform provides general wellbeing support and is not medical advice.</p>
</footer>

<!-- âœ… FRONTEND-ONLY JS (NO LOCALHOST, NO BACKEND_URL) -->
<script>
/* Theme */
const themeToggle = document.getElementById('themeToggle');
function applyTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸ Light' : 'ğŸŒ™ Dark';
  localStorage.setItem('yc_theme', theme);
}
applyTheme(localStorage.getItem('yc_theme') || 'light');
themeToggle.addEventListener('click', () => {
  const cur = document.body.getAttribute('data-theme') || 'light';
  applyTheme(cur === 'dark' ? 'light' : 'dark');
});

/* Daily boosts */
const boosts = [
"You are doing better than you think ğŸ’›","Tiny steps are still progress ğŸŒ±","Resting is part of healing ğŸŒ¸",
"You are growing in calm and confidence ğŸŒ¿","You deserve the same care you give others ğŸ’«",
"Every breath is a chance to begin again ğŸŒ…","Your feelings are valid and temporary ğŸŒ™",
"Small acts of self-care create big changes âœ¨","You are stronger than you realize ğŸ’ª",
"Progress isn't always visible, but it's happening ğŸŒ¸"
];
window.getBoost = function getBoost() {
  document.getElementById("boostText").textContent = boosts[Math.floor(Math.random() * boosts.length)];
};

/* Steps (local only) */
let localSteps = 0;
window.addSteps = function addSteps() {
  const input = document.getElementById("addStepsInput");
  const stepsToAdd = Number(input.value);
  if (!stepsToAdd || stepsToAdd <= 0) return;
  localSteps += stepsToAdd;
  document.getElementById("stepsCount").textContent = localSteps;
  input.value = "";
};

/* Mood */
window.logMood = function logMood(mood) {
  const log = document.getElementById("moodLog");
  const time = new Date().toLocaleTimeString();
  log.textContent = `Last mood: ${mood} (${time})`;
};

/* Luna (local fallback only) */
function getEmpatheticReply(text) {
  const lower = text.toLowerCase();
  if (lower.includes("hurt myself") || lower.includes("kill myself") || lower.includes("suicide")) {
    return `I'm really concerned about you ğŸ’› Please reach out for immediate help:<br><br>
    ğŸ†˜ <strong>Crisis Support:</strong><br>
    â€¢ Emergency: 999 (UK) / 911 (US)<br>
    â€¢ Samaritans (UK): 116 123<br>
    â€¢ US: Call/Text 988<br><br>
    You matter and there are people who want to help you. ğŸŒ™`;
  }
  if (lower.includes("sad") || lower.includes("tired") || lower.includes("depressed"))
    return "I'm sorry you're feeling that way ğŸ’› It's okay to rest. You're doing the best you can.";
  if (lower.includes("happy") || lower.includes("good"))
    return "Thatâ€™s lovely to hear ğŸŒ¸ Hold onto that moment â€” it matters.";
  if (lower.includes("anxious") || lower.includes("worried"))
    return "Breathe gently ğŸŒ¿ Try the 5-4-3-2-1 grounding exercise in the coping library.";
  return "Thank you for sharing ğŸŒ™ Iâ€™m here with you. Whatâ€™s been on your mind?";
}

window.sendMessage = function sendMessage() {
  const chatInput = document.getElementById("chatInput");
  const chatBox = document.getElementById("chatBox");
  const userMsg = chatInput.value.trim();
  if (!userMsg) return;

  const userDiv = document.createElement("div");
  userDiv.className = "msg user";
  userDiv.innerHTML = `<strong>You:</strong> ${userMsg}`;
  chatBox.appendChild(userDiv);
  chatInput.value = "";

  const reply = document.createElement("div");
  reply.className = "msg ai";
  reply.innerHTML = `<strong>Luna:</strong> ${getEmpatheticReply(userMsg)}`;
  chatBox.appendChild(reply);

  chatBox.scrollTop = chatBox.scrollHeight;
};

window.clearChat = function clearChat() {
  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML = `<div class="msg ai"><strong>Luna:</strong> Hi there ğŸ’› How are you feeling today?</div>`;
};

/* Mini featured meditation player */
async function initMiniPlayer() {
  try {
    const res = await fetch('media/manifest.json');
    if (!res.ok) return;
    const manifest = await res.json();
    const t = (manifest.meditations && manifest.meditations[0]) || (manifest.whiteNoises && manifest.whiteNoises[0]);
    if (!t) return;

    const titleEl = document.getElementById('miniTitle');
    const byEl = document.getElementById('miniBy');
    const audio = document.getElementById('miniAudio');
    const btn = document.getElementById('miniPlayBtn');
    if (!titleEl || !byEl || !audio || !btn) return;

    titleEl.textContent = t.label;
    byEl.textContent = `by ${t.author}`;
    audio.src = t.file;

    let playing = false;
    btn.addEventListener('click', async () => {
      if (!playing) { try { await audio.play(); } catch(e) {} playing = true; btn.textContent = 'Pause'; }
      else { audio.pause(); playing = false; btn.textContent = 'Play'; }
    });

    audio.addEventListener('ended', () => { playing = false; btn.textContent = 'Play'; });
  } catch(e) {}
}
document.addEventListener('DOMContentLoaded', initMiniPlayer);
</script>

<!-- Cookie banner -->
<div id="cookie-banner" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#222;color:#fff;padding:12px;text-align:center;font-size:0.9rem;">
  ğŸª We use cookies to improve your experience.
  <button id="cookie-accept" style="margin-left:10px;padding:4px 10px;border:none;border-radius:6px;background:#ffc107;color:#000;font-weight:bold;cursor:pointer;">OK</button>
</div>

<button id="donationFab" aria-label="Support Us">ğŸ’œ Support Us</button>

<div id="donationModal" hidden>
  <div class="donation-card">
    <button id="donationClose">Ã—</button>
    <h2>Support YouCanHeal</h2>
    <p>Your support keeps this platform free ğŸ’›</p>

    <button class="donate-amount active" data-amt="2">Â£2 / month</button>
    <button class="donate-amount" data-amt="5">Â£5 / month</button>

    <button id="stripeDonateBtn" class="btn" type="button">Donate via Stripe</button>
    <div id="paypal-button-container"></div>
  </div>
</div>

<button id="contactBtn" aria-label="Contact YouCanHeal">ğŸ“© Contact</button>

<div id="contactModal" hidden>
  <div class="contact-card">
    <button id="contactClose" type="button">Ã—</button>
    <h2>Contact YouCanHeal</h2>
    <p>We reply from our Zoho Mail inbox within 2 working days.</p>

    <form action="mailto:support@youcanheal.co.uk" method="post" enctype="text/plain">
      <input type="email" name="replyTo" placeholder="Your email" required />
      <textarea name="message" rows="4" placeholder="How can we help?" required></textarea>
      <p class="contact-note">Partner enquiries: <a href="mailto:partners@youcanheal.co.uk">partners@youcanheal.co.uk</a></p>
      <button type="submit" class="btn">Send via Email</button>
    </form>
  </div>
</div>

<script>
/* Cookie banner */
if (!localStorage.getItem('yc_cookie')) {
  const banner = document.getElementById('cookie-banner');
  banner.style.display = 'block';
  document.getElementById('cookie-accept').onclick = () => {
    localStorage.setItem('yc_cookie','true');
    banner.style.display = 'none';
  };
}

/* Donation + contact modals */
const donationFab = document.getElementById("donationFab");
const donationModal = document.getElementById("donationModal");
const donationCloseBtn = document.getElementById("donationClose");
const amountButtons = Array.from(document.querySelectorAll(".donate-amount"));
const stripeBtn = document.getElementById("stripeDonateBtn");

donationFab.addEventListener("click", () => donationModal.hidden = false);
donationCloseBtn.addEventListener("click", () => donationModal.hidden = true);
donationModal.addEventListener("click", (e) => { if (e.target === donationModal) donationModal.hidden = true; });

amountButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    amountButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});

const DONATION_PAYPAL_PLANS = { 2: "P-6PU50610GN123364SNE27HYY", 5: "P-8J411952AV1634600NE27J6Q" };
const getSelectedAmount = () => Number((amountButtons.find(b => b.classList.contains("active")) || amountButtons[0]).dataset.amt);

/* Stripe button (safe) */
stripeBtn.addEventListener("click", () => {
  alert("Stripe checkout requires a deployed backend endpoint. When your backend is live, Iâ€™ll wire this button to it safely.");
});

/* PayPal buttons */
if (window.paypal?.Buttons) {
  window.paypal.Buttons({
    style: { layout: "vertical", color: "gold", shape: "rect", label: "subscribe" },
    createSubscription(data, actions) {
      const amount = getSelectedAmount();
      const plan = DONATION_PAYPAL_PLANS[amount];
      if (!plan) { alert("Please select Â£2 or Â£5."); return; }
      return actions.subscription.create({ plan_id: plan });
    },
    onApprove() { alert("Thank you for supporting YouCanHeal via PayPal! ğŸ’›"); donationModal.hidden = true; },
    onError() { alert("PayPal could not start the subscription. Please try again."); }
  }).render("#paypal-button-container");
}

/* Contact modal */
const contactBtn = document.getElementById("contactBtn");
const contactModal = document.getElementById("contactModal");
const contactCloseBtn = document.getElementById("contactClose");
contactBtn.addEventListener("click", () => contactModal.hidden = false);
contactCloseBtn.addEventListener("click", () => contactModal.hidden = true);
contactModal.addEventListener("click", (e) => { if (e.target === contactModal) contactModal.hidden = true; });
</script>

</body>
</html>
